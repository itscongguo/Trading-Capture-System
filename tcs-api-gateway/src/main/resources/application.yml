spring:
  application:
    name: tcs-api-gateway

  cloud:
    gateway:
      routes:
        # Auth Service Routes
        - id: auth-service
          uri: http://${AUTH_SERVICE_HOST:localhost}:${AUTH_SERVICE_PORT:8084}
          predicates:
            - Path=/api/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: auth-service-cb
                fallbackUri: forward:/fallback/auth

        # Order Service Routes
        - id: order-service
          uri: http://${ORDER_SERVICE_HOST:localhost}:${ORDER_SERVICE_PORT:8081}
          predicates:
            - Path=/api/orders/**
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: order-service-cb
                fallbackUri: forward:/fallback/order

        # Risk Service Routes (internal only, not exposed)
        - id: risk-service
          uri: http://${RISK_SERVICE_HOST:localhost}:${RISK_SERVICE_PORT:8082}
          predicates:
            - Path=/api/risk/**
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: risk-service-cb

      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - Authorization
            maxAge: 3600

      # Default Filters
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}

server:
  port: 8080

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# Application specific config
app:
  jwt:
    secret: ${JWT_SECRET:TCS-Trading-Capture-System-Secret-Key-2024-Very-Long-And-Secure}
  rate-limit:
    enabled: true
    requests-per-second: 100

resilience4j:
  circuitbreaker:
    instances:
      auth-service-cb:
        slidingWindowSize: 10
        permittedNumberOfCallsInHalfOpenState: 3
        slidingWindowType: COUNT_BASED
        minimumNumberOfCalls: 5
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
      order-service-cb:
        slidingWindowSize: 10
        permittedNumberOfCallsInHalfOpenState: 3
        slidingWindowType: COUNT_BASED
        minimumNumberOfCalls: 5
        waitDurationInOpenState: 10s
        failureRateThreshold: 50

logging:
  level:
    root: INFO
    com.tcs: DEBUG
    org.springframework.cloud.gateway: DEBUG
